
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            background: #000000 !important;
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        /* æˆæƒæç¤ºé®ç½© */
        #permissionMask {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 20000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #ddd;
            text-align: center;
            padding: 30px;
            backdrop-filter: blur(5px);
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #permissionMask.visible {
            visibility: visible;
            opacity: 1;
        }
        #permissionMask h3 {
            margin-bottom: 20px;
            color: #fff;
        }
        #permissionMask p {
            margin-bottom: 30px;
            line-height: 1.5;
            max-width: 300px;
        }
        #requestPermissionBtn {
            background: #2a5ca7;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        #requestPermissionBtn:active {
            background: #1e4a8a;
        }
        /* å€’è®¡æ—¶æç¤º */
        #countdownText {
            margin-top: 25px;
            font-size: 14px;
            color: #888;
        }
        /* é•¿æŒ‰åé¦ˆåœ†ç¯ */
        #pressRing {
            position: fixed;
            pointer-events: none;
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            opacity: 0;
            transform: scale(0);
            transition: opacity 0.3s, transform 0.3s;
            z-index: 9998;
        }
        #pressRing.active {
            opacity: 1;
            transform: scale(1);
        }
        /* éšè—çš„æ§åˆ¶é¢æ¿ */
        #controlPanel {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(25, 25, 25, 0.97);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
            color: white;
            text-align: center;
            z-index: 10000;
            display: none;
            min-width: 260px;
            backdrop-filter: blur(10px);
        }
        #controlPanel.active { display: block; }
        .control-btn {
            background: rgba(255, 255, 255, 0.08);
            color: #ddd;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 14px;
            margin: 8px 0;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }
        .control-btn:active { background: rgba(255, 255, 255, 0.15); }
        .control-btn.primary { 
            background: #2a5ca7; 
            border-color: #2a5ca7;
            color: white;
        }
        .control-btn.warning { 
            background: rgba(200, 100, 0, 0.7); 
            border-color: rgba(200, 100, 0, 0.5);
            color: white;
        }
        .control-btn.success { 
            background: rgba(0, 150, 0, 0.7); 
            border-color: rgba(0, 150, 0, 0.5);
            color: white;
        }
        /* çŠ¶æ€æŒ‡ç¤ºç¯ */
        #statusLed {
            position: fixed;
            bottom: 18px; right: 18px;
            width: 7px; height: 7px;
            border-radius: 50%;
            background: #111;
            z-index: 9999;
        }
        #statusLed.active {
            background: #ff9900;
            box-shadow: 0 0 8px #ff9900;
        }
        /* ç›‘å¬çŠ¶æ€æŒ‡ç¤ºç¯ */
        #listeningLed {
            position: fixed;
            bottom: 18px; right: 32px;
            width: 7px; height: 7px;
            border-radius: 50%;
            background: #0a6;
            z-index: 9999;
            opacity: 0.7;
            box-shadow: 0 0 5px #0a6;
        }
        #listeningLed.inactive {
            background: #666;
            box-shadow: none;
        }
        /* é…ç½®é”™è¯¯æç¤º */
        #configError {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(180, 40, 40, 0.95);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 10001;
            display: none;
            border: 1px solid #a02a2a;
            max-width: 80%;
        }
    </style>
</head>
<body>
    <!-- æˆæƒæç¤ºé®ç½© -->
    <div id="permissionMask">
        <h3>ğŸ“¸ æƒé™è¯·æ±‚</h3>
        <p>è¯·å…è®¸è®¿é—®æ‘„åƒå¤´ï¼Œä»¥ä½¿ç”¨æ‰‹ç”µç­’ï¼ˆé—ªå…‰ç¯ï¼‰åŠŸèƒ½ã€‚æ­¤æƒé™ä»…ç”¨äºæ§åˆ¶é—ªå…‰ç¯ï¼Œä¸ä¼šå½•åˆ¶æˆ–ä¿å­˜ä»»ä½•å½±åƒã€‚</p>
        <button id="requestPermissionBtn">å…è®¸è®¿é—®æ‘„åƒå¤´</button>
        <div id="countdownText"></div>
    </div>

    <!-- é•¿æŒ‰åé¦ˆåœ†ç¯ -->
    <div id="pressRing"></div>
    <!-- é…ç½®é”™è¯¯æç¤º -->
    <div id="configError"></div>
    <!-- çŠ¶æ€æŒ‡ç¤ºç¯ï¼ˆæ‰‹ç”µç­’ï¼‰ -->
    <div id="statusLed"></div>
    <!-- ç›‘å¬çŠ¶æ€æŒ‡ç¤ºç¯ -->
    <div id="listeningLed" class="inactive"></div>
    <!-- éšè—çš„æ§åˆ¶é¢æ¿ -->
    <div id="controlPanel">
        <div style="margin-bottom:18px; font-size:16px; font-weight:500;">æ§åˆ¶é¢æ¿</div>
        
        <!-- æ‰‹ç”µç­’æ§åˆ¶ -->
        <button class="control-btn primary" id="toggleBtn">å¼€å¯æ‰‹ç”µç­’</button>
        
        <!-- ç›‘å¬æ§åˆ¶ -->
        <button class="control-btn warning" id="toggleListeningBtn">åœæ­¢äº‘ç›‘å¬</button>
        
        <!-- å…¶ä»–åŠŸèƒ½ -->
        <button class="control-btn" id="checkBtn">ç«‹å³æ£€æŸ¥æŒ‡ä»¤</button>
        <button class="control-btn" id="closePanelBtn">å…³é—­é¢æ¿</button>
        
        <!-- çŠ¶æ€ä¿¡æ¯ -->
        <div style="margin-top:15px; font-size:11px; color:#777; word-break:break-all;" id="configInfo"></div>
        <div style="margin-top:8px; font-size:11px; color:#666;" id="listeningStatus">
            äº‘ç›‘å¬çŠ¶æ€ï¼š<span id="listeningStatusText">è¿è¡Œä¸­</span>
        </div>
    </div>

    <script>
        // ====================ã€ä»URLè·å–é…ç½®ã€‘====================
        function getConfigFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return { 
                fileId: params.get('file_id'), 
                nodeId: params.get('node_id') 
            };
        }

        // ====================ã€å…¨å±€å˜é‡ã€‘====================
        let DYNALIST_DOCUMENT_ID = null;
        let TARGET_NODE_ID = null;
        const DYNALIST_API_TOKEN = 'Uvkd-9_OhN3kJn_TLhB-yrxd4mHYnPZ-A1XPtM_66JkRAsx6VwnWtHaKhuD9RaLKEupSkxxALzqGcjZjs9fbkMBam6Z3AR_QTW9h5062CpayU-Rm58pbbBlp3qyaWNHo';
        const CHECK_INTERVAL = 3000;
        const TARGET_COMMAND = 'æ‰“å¼€æ‰‹ç”µç­’';

        let mediaStream = null;
        let track = null;
        let isFlashlightOn = false;
        let checkIntervalId = null;
        let isListeningActive = true;
        let longPressTimer = null;
        // åˆ é™¤äº†è·³è½¬ç›¸å…³çš„å®šæ—¶å™¨å’Œå˜é‡

        const permissionMask = document.getElementById('permissionMask');
        const requestPermissionBtn = document.getElementById('requestPermissionBtn');
        const countdownText = document.getElementById('countdownText');
        const pressRing = document.getElementById('pressRing');
        const configError = document.getElementById('configError');
        const statusLed = document.getElementById('statusLed');
        const listeningLed = document.getElementById('listeningLed');
        const controlPanel = document.getElementById('controlPanel');
        const configInfo = document.getElementById('configInfo');
        const toggleBtn = document.getElementById('toggleBtn');
        const toggleListeningBtn = document.getElementById('toggleListeningBtn');
        const checkBtn = document.getElementById('checkBtn');
        const closePanelBtn = document.getElementById('closePanelBtn');
        const listeningStatusText = document.getElementById('listeningStatusText');

        // ====================ã€ç®€åŒ–ï¼šç›‘å¬æ§åˆ¶å‡½æ•°ã€‘====================
        function updateListeningStatus() {
            if (isListeningActive) {
                listeningLed.classList.remove('inactive');
                toggleListeningBtn.textContent = 'åœæ­¢äº‘ç›‘å¬';
                toggleListeningBtn.className = 'control-btn warning';
                listeningStatusText.textContent = 'è¿è¡Œä¸­';
                listeningStatusText.style.color = '#0a6';
            } else {
                listeningLed.classList.add('inactive');
                toggleListeningBtn.textContent = 'å¼€å¯äº‘ç›‘å¬';
                toggleListeningBtn.className = 'control-btn success';
                listeningStatusText.textContent = 'å·²åœæ­¢';
                listeningStatusText.style.color = '#999';
            }
        }

        function stopListening() {
            if (checkIntervalId) {
                clearInterval(checkIntervalId);
                checkIntervalId = null;
                console.log('äº‘ç›‘å¬å·²åœæ­¢');
            }
            isListeningActive = false;
            updateListeningStatus();
            
            // ç®€åŒ–ï¼šç›´æ¥è·³è½¬ï¼Œä¸æ˜¾ç¤ºå€’è®¡æ—¶
            console.log('æ­£åœ¨è·³è½¬åˆ°ç™¾åº¦é¦–é¡µ...');
            window.location.href = 'https://www.baidu.com';
        }

        function startListening() {
            if (!isListeningActive) return;
            
            checkAndExecuteCommand();
            checkIntervalId = setInterval(checkAndExecuteCommand, CHECK_INTERVAL);
            console.log('äº‘ç›‘å¬å·²å¯åŠ¨');
        }

        function toggleListening() {
            isListeningActive = !isListeningActive;
            
            if (isListeningActive) {
                startListening();
            } else {
                stopListening();
            }
            
            updateListeningStatus();
        }

        // ====================ã€1. æ£€æµ‹æ‘„åƒå¤´æƒé™çŠ¶æ€ã€‘====================
        async function checkCameraPermission() {
            if (!navigator.permissions || !navigator.permissions.query) {
                console.log('æµè§ˆå™¨ä¸æ”¯æŒæƒé™çŠ¶æ€æŸ¥è¯¢');
                return null;
            }
            try {
                const permissionStatus = await navigator.permissions.query({ 
                    name: 'camera' 
                });
                console.log('æ‘„åƒå¤´æƒé™çŠ¶æ€:', permissionStatus.state);
                return permissionStatus.state;
            } catch (error) {
                console.log('æŸ¥è¯¢æƒé™çŠ¶æ€å¤±è´¥:', error);
                return null;
            }
        }

        // ====================ã€2. è¯·æ±‚æ‘„åƒå¤´æƒé™ã€‘====================
        async function requestCameraPermission() {
            if (!navigator.mediaDevices?.getUserMedia) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®ã€‚è¯·ä½¿ç”¨ Chrome æˆ– Edgeã€‚');
                return false;
            }
            try {
                const testStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true
                });
                testStream.getTracks().forEach(track => track.stop());
                console.log('âœ… æ‘„åƒå¤´æƒé™å·²è·å–');
                return true;
            } catch (error) {
                console.error('æ‘„åƒå¤´æƒé™è¢«æ‹’ç»:', error);
                if (error.name === 'NotAllowedError') {
                    alert('è¯·å…è®¸æ‘„åƒå¤´æƒé™ä»¥ä½¿ç”¨æ‰‹ç”µç­’åŠŸèƒ½ã€‚æ‚¨å¯èƒ½éœ€è¦åˆ·æ–°é¡µé¢é‡æ–°æˆæƒã€‚');
                }
                return false;
            }
        }

        // ====================ã€3. æƒé™é€šè¿‡åçš„æµç¨‹ã€‘====================
        function startSystemAfterPermission() {
            let countdown = 3;
            countdownText.textContent = `ç³»ç»Ÿå‡†å¤‡ä¸­... ${countdown}ç§’`;
            
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    countdownText.textContent = `ç³»ç»Ÿå‡†å¤‡ä¸­... ${countdown}ç§’`;
                } else {
                    clearInterval(countdownInterval);
                    permissionMask.classList.remove('visible');
                    finalSystemStart();
                }
            }, 1000);
        }

        // ====================ã€4. ç³»ç»Ÿæœ€ç»ˆå¯åŠ¨ã€‘====================
        function finalSystemStart() {
            if (!initConfig()) return;
            startListening();
            updateListeningStatus();
            console.log('ğŸš€ ç³»ç»Ÿå·²å®Œå…¨å¯åŠ¨');
        }

        // ====================ã€5. é…ç½®åˆå§‹åŒ–ã€‘====================
        function initConfig() {
            const config = getConfigFromUrl();
            DYNALIST_DOCUMENT_ID = config.fileId;
            TARGET_NODE_ID = config.nodeId;

            if (!DYNALIST_DOCUMENT_ID || !TARGET_NODE_ID) {
                configError.innerHTML = `è¯·æä¾›URLå‚æ•°ï¼š?file_id=æ–‡æ¡£ID&node_id=èŠ‚ç‚¹ID`;
                configError.style.display = 'block';
                return false;
            }

            configInfo.textContent = `é…ç½®ï¼š${DYNALIST_DOCUMENT_ID.substring(0,12)}... / ${TARGET_NODE_ID.substring(0,12)}...`;
            return true;
        }

        // ====================ã€6. æ™ºèƒ½å¯åŠ¨å…¥å£ã€‘====================
        async function smartStart() {
            if (!initConfig()) return;

            const permissionState = await checkCameraPermission();
            
            if (permissionState === 'granted') {
                console.log('æƒé™å·²æˆäºˆï¼Œç›´æ¥å¯åŠ¨ç³»ç»Ÿ');
                permissionMask.classList.remove('visible');
                finalSystemStart();
            } 
            else if (permissionState === 'prompt' || permissionState === null) {
                console.log('éœ€è¦è¯·æ±‚æƒé™');
                permissionMask.classList.add('visible');
                
                requestPermissionBtn.addEventListener('click', async () => {
                    const granted = await requestCameraPermission();
                    if (granted) {
                        startSystemAfterPermission();
                    }
                });
            } 
            else if (permissionState === 'denied') {
                console.log('æƒé™å·²è¢«æ‹’ç»');
                permissionMask.innerHTML = `
                    <h3>âš ï¸ æƒé™è¢«æ‹’ç»</h3>
                    <p>æ‘„åƒå¤´è®¿é—®æƒé™å·²è¢«æ‹’ç»ã€‚è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸æ­¤ç½‘ç«™çš„æ‘„åƒå¤´æƒé™ï¼Œç„¶ååˆ·æ–°é¡µé¢ã€‚</p>
                    <p style="font-size:14px; color:#aaa; margin-top:20px;">
                        é€šå¸¸å¯ä»¥åœ¨ï¼š<br>
                        Â· åœ°å€æ å·¦ä¾§çš„é”å½¢å›¾æ ‡<br>
                        Â· æµè§ˆå™¨è®¾ç½® â†’ ç½‘ç«™è®¾ç½® â†’ æ‘„åƒå¤´<br>
                        ä¸­ä¿®æ”¹æƒé™ã€‚
                    </p>
                `;
                permissionMask.classList.add('visible');
            }
        }

        // ====================ã€7. é•¿æŒ‰æ£€æµ‹ã€‘====================
        document.addEventListener('touchstart', function(e) {
            const touch = e.touches[0];
            const x = touch.clientX;
            const y = touch.clientY;

            pressRing.style.left = (x - 50) + 'px';
            pressRing.style.top = (y - 50) + 'px';
            pressRing.style.width = '100px';
            pressRing.style.height = '100px';
            pressRing.classList.add('active');

            longPressTimer = setTimeout(() => {
                controlPanel.classList.add('active');
                pressRing.classList.remove('active');
            }, 1500);
        });

        document.addEventListener('touchend', function() {
            clearTimeout(longPressTimer);
            pressRing.classList.remove('active');
        });

        document.addEventListener('touchmove', function(e) {
            const touch = e.touches[0];
            const startX = parseInt(pressRing.style.left) + 50;
            const startY = parseInt(pressRing.style.top) + 50;
            const moveX = touch.clientX;
            const moveY = touch.clientY;
            const distance = Math.sqrt(Math.pow(moveX - startX, 2) + Math.pow(moveY - startY, 2));

            if (distance > 30) {
                clearTimeout(longPressTimer);
                pressRing.classList.remove('active');
            }
        });

        // ====================ã€8. é¢æ¿æŒ‰é’®åŠŸèƒ½ã€‘====================
        toggleBtn.addEventListener('click', async () => {
            isFlashlightOn ? await turnOffFlashlight() : await turnOnFlashlight();
        });

        toggleListeningBtn.addEventListener('click', toggleListening);

        checkBtn.addEventListener('click', () => {
            checkAndExecuteCommand();
        });

        closePanelBtn.addEventListener('click', () => {
            controlPanel.classList.remove('active');
        });

        // ====================ã€9. æ‰‹ç”µç­’æ§åˆ¶ã€‘====================
        function updateStatusLed(isActive) {
            statusLed.classList.toggle('active', isActive);
        }

        async function turnOnFlashlight() {
            if (isFlashlightOn) return;
            
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                track = mediaStream.getVideoTracks()[0];
                if (!track.getCapabilities().torch) {
                    alert('æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒé—ªå…‰ç¯åŠŸèƒ½ã€‚');
                    return;
                }
                await track.applyConstraints({ advanced: [{ torch: true }] });
                isFlashlightOn = true;
                updateStatusLed(true);
                toggleBtn.textContent = 'å…³é—­æ‰‹ç”µç­’';
            } catch (error) {
                console.error('å¼€å¯å¤±è´¥:', error);
                alert('å¼€å¯å¤±è´¥: ' + error.message);
            }
        }

        async function turnOffFlashlight() {
            if (!isFlashlightOn || !track) return;
            try {
                await track.applyConstraints({ advanced: [{ torch: false }] });
            } catch(e) { console.error(e); }
            mediaStream.getTracks().forEach(t => t.stop());
            mediaStream = null; track = null; isFlashlightOn = false;
            updateStatusLed(false);
            toggleBtn.textContent = 'å¼€å¯æ‰‹ç”µç­’';
        }

        // ====================ã€10. äº‘ç«¯æŒ‡ä»¤ç›‘å¬ã€‘====================
        async function fetchCommandFromDynalist() {
            if (!DYNALIST_DOCUMENT_ID || !TARGET_NODE_ID) return null;
            try {
                const response = await fetch('https://dynalist.io/api/v1/doc/read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        token: DYNALIST_API_TOKEN, 
                        file_id: DYNALIST_DOCUMENT_ID 
                    })
                });
                const data = await response.json();
                const targetNode = data.nodes?.find(n => n.id === TARGET_NODE_ID);
                return targetNode?.content?.trim();
            } catch(error) {
                console.log('è·å–æŒ‡ä»¤å¤±è´¥:', error);
                return null;
            }
        }

        async function checkAndExecuteCommand() {
            if (!isListeningActive) return;
            
            const command = await fetchCommandFromDynalist();
            if (!command) return;
            console.log('æ”¶åˆ°æŒ‡ä»¤:', command);
            if (command === TARGET_COMMAND) {
                await turnOnFlashlight();
            } else if (isFlashlightOn) {
                await turnOffFlashlight();
            }
        }

        // ====================ã€11. é¡µé¢æ¸…ç†ã€‘====================
        window.addEventListener('beforeunload', () => {
            if (checkIntervalId) clearInterval(checkIntervalId);
            turnOffFlashlight();
        });

        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isFlashlightOn) turnOffFlashlight();
        });

        // ====================ã€12. ä¸»å…¥å£ã€‘====================
        document.addEventListener('DOMContentLoaded', smartStart);
    </script>
</body>
</html>